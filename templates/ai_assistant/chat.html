{% extends 'base.html' %}
{% block title %}AI Assistant - LearnSphere{% endblock %}
{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <div class="col-md-3 border-end bg-light p-0">
            <div class="p-3 border-bottom bg-white">
                <h5 class="mb-3"><i class="bi bi-robot me-2 text-primary"></i>AI Assistant</h5>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" data-agent="teacher">
                        <i class="bi bi-person-workspace"></i> Teacher
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" data-agent="parent">
                        <i class="bi bi-people"></i> Parent
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" data-agent="student">
                        <i class="bi bi-mortarboard"></i> Student
                    </button>
                </div>
            </div>
            <div class="p-3">
                <button id="newChatBtn" class="btn btn-primary w-100 mb-3">
                    <i class="bi bi-plus-circle me-2"></i>New Chat
                </button>
                <h6 class="text-muted small mb-2">Recent Conversations</h6>
                <div id="conversationList" class="list-group">
                    {% for conv in conversations %}
                    <a href="#" class="list-group-item list-group-item-action conversation-item"
                        data-conv-id="{{ conv.id }}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 small">{{ conv.title }}</h6>
                            <small class="text-muted">{{ conv.updated_at|date:"M d" }}</small>
                        </div>
                        <small class="text-muted">{{ conv.get_agent_type_display }}</small>
                    </a>
                    {% empty %}
                    <p class="text-muted small">No conversations yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-9 d-flex flex-column p-0">
            <div class="p-3 border-bottom bg-white">
                <h6 class="mb-0" id="chatTitle">Select or start a new conversation</h6>
                <small class="text-muted" id="agentType"></small>
            </div>
            <div id="chatMessages" class="flex-grow-1 p-4 overflow-auto" style="max-height: calc(100vh - 250px);">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-chat-dots fs-1 d-block mb-3"></i>
                    <p>Start a conversation with your AI assistant</p>
                </div>
            </div>
            <div class="p-3 border-top bg-light">
                <form id="messageForm">
                    <div class="input-group">
                        <input type="text" id="messageInput" class="form-control" placeholder="Type your message..."
                            disabled>
                        <button type="submit" class="btn btn-primary" id="sendBtn" disabled>
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                    <div id="typingIndicator" class="text-muted small mt-2" style="display: none;">
                        <i class="bi bi-three-dots"></i> AI is thinking...
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let currentConversationId = null;
    let currentAgentType = '{{ default_agent }}';

    document.addEventListener('DOMContentLoaded', function () {
        const agentButtons = document.querySelectorAll('[data-agent]');
        agentButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                agentButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentAgentType = this.dataset.agent;
            });
        });
        agentButtons.forEach(btn => {
            if (btn.dataset.agent === currentAgentType) {
                btn.classList.add('active');
            }
        });
        document.getElementById('newChatBtn').addEventListener('click', startNewConversation);
        document.getElementById('messageForm').addEventListener('submit', sendMessage);
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                loadConversation(this.dataset.convId);
            });
        });
    });

    async function startNewConversation() {
        let response;
        try {
            response = await fetch("{% url 'ai_assistant:start_conversation' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ agent_type: currentAgentType })
            });
            const data = await response.json();
            if (response.ok) {
                currentConversationId = data.conversation_id;
                document.getElementById('chatTitle').textContent = `New ${currentAgentType.charAt(0).toUpperCase() + currentAgentType.slice(1)} Chat`;
                document.getElementById('agentType').textContent = data.agent_type;
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            } else {
                alert('Error starting conversation: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            if (response) {
                alert(`Failed to start conversation. Status: ${response.status} ${response.statusText}. Error: ${error.message}`);
                // Try to get text if JSON failed
                response.text().then(text => console.error('Response text:', text));
            } else {
                alert('Failed to start conversation. Network error or code issue: ' + error.message);
            }
        }
    }

    async function sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message || !currentConversationId) return;
        addMessageToChat('user', message);
        input.value = '';
        document.getElementById('typingIndicator').style.display = 'block';

        // Construct URL dynamically since we need conversation ID
        // We'll use a placeholder and replace it
        const url = "{% url 'ai_assistant:send_message' 0 %}".replace('0', currentConversationId);

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ message: message })
            });
            const data = await response.json();
            document.getElementById('typingIndicator').style.display = 'none';
            if (response.ok) {
                addMessageToChat('assistant', data.response);
                if (data.actions && data.actions.length > 0) {
                    addActionsToChat(data.actions);
                }
            } else {
                alert('Error sending message: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('typingIndicator').style.display = 'none';
            alert('Failed to send message');
        }
    }

    async function loadConversation(convId) {
        try {
            const url = "{% url 'ai_assistant:conversation_history' 0 %}".replace('0', convId);
            const response = await fetch(url);
            const data = await response.json();
            if (response.ok) {
                currentConversationId = data.conversation_id;
                document.getElementById('chatTitle').textContent = `Conversation #${convId}`;
                document.getElementById('agentType').textContent = data.agent_type;
                document.getElementById('chatMessages').innerHTML = '';
                data.messages.forEach(msg => {
                    addMessageToChat(msg.role, msg.content);
                });
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            } else {
                alert('Error loading conversation: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to load conversation');
        }
    }

    function addMessageToChat(role, content) {
        const chatDiv = document.getElementById('chatMessages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `mb-3 ${role === 'user' ? 'text-end' : ''}`;
        const bubble = document.createElement('div');
        bubble.className = `d-inline-block p-3 rounded ${role === 'user' ? 'bg-primary text-white' : 'bg-light'}`;
        bubble.style.maxWidth = '70%';
        bubble.textContent = content;
        msgDiv.appendChild(bubble);
        chatDiv.appendChild(msgDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function addActionsToChat(actions) {
        const chatDiv = document.getElementById('chatMessages');
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'mb-3';
        actionsDiv.innerHTML = `<div class="alert alert-info"><strong>Actions Performed:</strong><ul class="mb-0 mt-2">${actions.map(a => `<li>${a.type}: ${a.description || a.student || a.title}</li>`).join('')}</ul></div>`;
        chatDiv.appendChild(actionsDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    #chatMessages {
        background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
    }

    .conversation-item.active {
        background-color: #e7f3ff;
        border-left: 3px solid #0d6efd;
    }
</style>
{% endblock %}