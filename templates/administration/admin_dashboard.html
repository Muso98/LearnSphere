{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% block title %}Admin Dashboard - LearnSphere{% endblock %}
{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border-left: 4px solid #667eea;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    .quick-action-btn {
        border-radius: 15px;
        padding: 15px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .quick-action-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .activity-item {
        border-left: 3px solid #e2e8f0;
        padding-left: 15px;
        margin-bottom: 15px;
        transition: border-color 0.3s;
    }

    .activity-item:hover {
        border-color: #667eea;
    }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold"><i class="bi bi-speedometer2 me-2"></i>{% trans "Admin Dashboard" %}</h1>
        <div>
            <a href="{% url 'admin:index' %}" class="btn btn-outline-primary me-2"><i class="bi bi-gear me-2"></i>Django
                Admin</a>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary"><i class="bi bi-house me-2"></i>{% trans "Asosiy sahifa" %}</a>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="glass-card stat-card p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">{% trans "Jami foydalanuvchilar" %}</p>
                        <h2 class="fw-bold mb-0">{{ total_users }}</h2>
                        <small class="text-success"><i class="bi bi-arrow-up"></i> {% trans "Faol" %}</small>
                    </div>
                    <div class="stat-icon" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;"><i
                            class="bi bi-people-fill"></i></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card stat-card p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">{% trans "O'quvchilar" %}</p>
                        <h2 class="fw-bold mb-0">{{ total_students }}</h2>
                        <small class="text-info"><i class="bi bi-mortarboard-fill"></i> {% trans "Aktiv" %}</small>
                    </div>
                    <div class="stat-icon" style="background:linear-gradient(135deg,#10b981,#059669);color:white;"><i
                            class="bi bi-person-badge"></i></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card stat-card p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">{% trans "Bugungi davomat" %}</p>
                        <h2 class="fw-bold mb-0">{{ attendance_rate }}%</h2>
                        <small class="text-warning"><i class="bi bi-calendar-check"></i> {% trans "Bugun" %}</small>
                    </div>
                    <div class="stat-icon" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;"><i
                            class="bi bi-clipboard-check"></i></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card stat-card p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">{% trans "O'rtacha baho" %}</p>
                        <h2 class="fw-bold mb-0">{{ avg_performance }}</h2>
                        <small class="text-success"><i class="bi bi-graph-up"></i> {% trans "30 kun" %}</small>
                    </div>
                    <div class="stat-icon" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;"><i
                            class="bi bi-trophy-fill"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-pie-chart-fill me-2 text-primary"></i>{% trans "Bugungi davomat" %}</h5>
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-bar-chart-fill me-2 text-primary"></i>{% trans "Fanlar bo'yicha o'zlashtirish" %}</h5>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-md-12">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-graph-up me-2 text-primary"></i>{% trans "Haftalik davomat tendensiyasi" %}
                </h5>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-star-fill me-2 text-warning"></i>{% trans "Eng yaxshi o'quvchilar" %}</h5>
                <div id="topStudentsList" class="mt-3">
                    <div class="text-center text-muted py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div> {% trans "Yuklanmoqda..." %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-exclamation-triangle-fill me-2 text-danger"></i>{% trans "E'tibor talab qiluvchilar" %}</h5>
                <div id="strugglingStudentsList" class="mt-3">
                    <div class="text-center text-muted py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div> {% trans "Yuklanmoqda..." %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-clock-history me-2 text-info"></i>{% trans "Oxirgi baholar" %}
                </h5>
                <div class="mt-3" style="max-height:400px;overflow-y:auto;">
                    {% for grade in recent_grades %}
                    <div class="activity-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ grade.student.get_full_name }}</strong> - {{ grade.subject.name }}
                                <br><small class="text-muted">{{ grade.teacher.get_full_name }} | {{ grade.date
                                    }}</small>
                            </div>
                            <span
                                class="badge {% if grade.value >= 4 %}bg-success{% elif grade.value >= 3 %}bg-warning{% else %}bg-danger{% endif %} rounded-pill px-3 py-2">{{
                                grade.value }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-3">{% trans "Hozircha baholar yo'q" %}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-person-plus-fill me-2 text-success"></i>{% trans "Yangi foydalanuvchilar" %}
                </h5>
                <div class="mt-3" style="max-height:400px;overflow-y:auto;">
                    {% for user in recent_users %}
                    <div class="activity-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ user.get_full_name|default:user.username }}</strong>
                                <br><small class="text-muted">{{ user.get_role_display }} | {{ user.date_joined|date:"d
                                    M Y" }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">{{ user.role }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-3">Hozircha yangi foydalanuvchilar yo'q</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-md-12">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-lightning-fill me-2 text-warning"></i>Tezkor harakatlar</h5>
                <div class="row g-3 mt-2">
                    <div class="col-md-3"><a href="{% url 'user_create' %}"
                            class="btn btn-primary quick-action-btn w-100"><i
                                class="bi bi-person-plus me-2"></i>Foydalanuvchi qo'shish</a></div>
                    <div class="col-md-3"><a href="{% url 'class_create' %}"
                            class="btn btn-success quick-action-btn w-100"><i class="bi bi-building me-2"></i>Sinf
                            yaratish</a></div>
                    <div class="col-md-3"><a href="{% url 'subject_create' %}"
                            class="btn btn-info quick-action-btn w-100"><i class="bi bi-book me-2"></i>Fan qo'shish</a>
                    </div>
                    <div class="col-md-3"><a href="{% url 'quarter_report' %}"
                            class="btn btn-warning quick-action-btn w-100"><i
                                class="bi bi-file-earmark-text me-2"></i>Hisobot yaratish</a></div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-3"><a href="{% url 'user_list' %}"
                            class="btn btn-outline-primary quick-action-btn w-100"><i
                                class="bi bi-people me-2"></i>Barcha foydalanuvchilar</a></div>
                    <div class="col-md-3"><a href="{% url 'class_list' %}"
                            class="btn btn-outline-success quick-action-btn w-100"><i
                                class="bi bi-building me-2"></i>Barcha sinflar</a></div>
                    <div class="col-md-3"><a href="{% url 'admin_grade_list' %}"
                            class="btn btn-outline-info quick-action-btn w-100"><i
                                class="bi bi-mortarboard me-2"></i>Barcha baholar</a></div>
                    <div class="col-md-3"><a href="{% url 'admin_attendance_list' %}"
                            class="btn btn-outline-warning quick-action-btn w-100"><i
                                class="bi bi-calendar-check me-2"></i>Davomat</a></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/administration/api/stats/attendance/').then(r => r.json()).then(data => {
            const ctx1 = document.getElementById('attendanceChart').getContext('2d');
            new Chart(ctx1, { type: 'doughnut', data: { labels: ['Kelgan', 'Kelmagan'], datasets: [{ data: [data.today.present, data.today.absent], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            const ctx3 = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx3, { type: 'line', data: { labels: data.weekly_trend.map(d => d.date), datasets: [{ label: 'Davomat %', data: data.weekly_trend.map(d => d.rate), borderColor: '#764ba2', backgroundColor: 'rgba(118,75,162,0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } } });
        });
        fetch('/administration/api/stats/performance/').then(r => r.json()).then(data => {
            const ctx2 = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx2, { type: 'bar', data: { labels: data.subjects, datasets: [{ label: 'O\'rtacha baho', data: data.averages, backgroundColor: '#667eea', borderRadius: 10 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 5 } } } });
        });
        fetch('/administration/api/stats/top-students/').then(r => r.json()).then(data => {
            const html = data.top_students.map((s, i) => `<div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" style="background:rgba(102,126,234,0.05);"><div><strong>${i + 1}. ${s.name}</strong><br><small class="text-muted">${s.grades_count} baho</small></div><span class="badge bg-success rounded-pill px-3 py-2">${s.average}</span></div>`).join('');
            document.getElementById('topStudentsList').innerHTML = html || '<p class="text-muted text-center">Ma\'lumot yo\'q</p>';
        });
        fetch('/administration/api/stats/struggling/').then(r => r.json()).then(data => {
            const html = data.struggling_students.map(s => `<div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" style="background:rgba(239,68,68,0.05);"><div><strong>${s.name}</strong><br><small class="text-muted">${s.class} | ${s.grades_count} baho</small></div><span class="badge bg-danger rounded-pill px-3 py-2">${s.average}</span></div>`).join('');
            document.getElementById('strugglingStudentsList').innerHTML = html || '<p class="text-muted text-center">Hammasi yaxshi!</p>';
        });
    });
</script>
{% endblock %}