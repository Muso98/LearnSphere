{% extends 'base.html' %}

{% block title %}Profil - LearnSphere{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-gradient text-white"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h4 class="mb-0"><i class="bi bi-person-circle me-2"></i>Foydalanuvchi Profili</h4>
            </div>
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Profile Picture Section -->
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}"
                                class="rounded-circle border border-3 border-primary" alt="Profile" width="150"
                                height="150" style="object-fit: cover;">
                            {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ user.first_name }}+{{ user.last_name }}&background=667eea&color=fff&size=150"
                                class="rounded-circle border border-3 border-primary" alt="Avatar" width="150"
                                height="150">
                            {% endif %}
                            <label for="profile_picture"
                                class="position-absolute bottom-0 end-0 btn btn-sm btn-primary rounded-circle"
                                style="width: 40px; height: 40px; cursor: pointer;" title="Rasmni o'zgartirish">
                                <i class="bi bi-camera-fill"></i>
                            </label>
                            <input type="file" id="profile_picture" name="profile_picture" class="d-none"
                                accept="image/*" onchange="previewImage(event)">
                        </div>
                        <h5 class="mt-3 mb-1">{{ user.first_name }} {{ user.last_name }}</h5>
                        <span class="badge bg-info">{{ user.get_role_display }}</span>
                    </div>

                    <!-- Profile Information -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold"><i class="bi bi-person me-2"></i>Ism</label>
                            <input type="text" name="first_name" class="form-control" value="{{ user.first_name }}"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold"><i class="bi bi-person me-2"></i>Familiya</label>
                            <input type="text" name="last_name" class="form-control" value="{{ user.last_name }}"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold"><i class="bi bi-envelope me-2"></i>Email</label>
                            <input type="email" name="email" class="form-control" value="{{ user.email }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold"><i class="bi bi-telephone me-2"></i>Telefon</label>
                            <input type="text" name="phone" class="form-control" value="{{ user.phone|default:'' }}"
                                placeholder="+998 XX XXX XX XX">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold"><i class="bi bi-chat-left-text me-2"></i>Bio</label>
                            <textarea name="bio" class="form-control" rows="3"
                                placeholder="O'zingiz haqingizda qisqacha...">{{ user.bio|default:'' }}</textarea>
                        </div>
                    </div>

                    <!-- Role-specific Information -->
                    {% if user.role == 'student' and user.student_class %}
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-building me-2"></i><strong>Sinf:</strong> {{ user.student_class }}
                    </div>
                    {% endif %}

                    {% if user.role == 'parent' %}
                    <div class="mt-3">
                        <h6 class="fw-bold"><i class="bi bi-people me-2"></i>Farzandlar:</h6>
                        <ul class="list-group">
                            {% for child in children %}
                            <li class="list-group-item">{{ child.first_name }} {{ child.last_name }} - {{
                                child.student_class }}</li>
                            {% empty %}
                            <li class="list-group-item text-muted">Farzandlar biriktirilmagan.</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if user.role == 'teacher' %}
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-award me-2"></i><strong>Qo'yilgan baholar:</strong> {{ grades_given }}
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle me-2"></i>Saqlash
                        </button>
                        <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Bekor qilish
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<!-- AI Data / Soft Skills Analytics -->
{% if skill_map %}
<div class="row justify-content-center mt-4 mb-5">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-cpu-fill me-2"></i>AI Tahlil: Qobiliyatlar
                    Xaritasi</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <canvas id="skillRadarChart"></canvas>
                    </div>
                    <div class="col-md-5">
                        <h6 class="text-muted text-uppercase small fw-bold mb-3">Xulosa</h6>
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item d-flex justify-content-between px-0">
                                <span>Tanqidiy fikrlash</span>
                                <span class="fw-bold text-primary">{{ skill_map.critical_thinking }}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between px-0">
                                <span>Ijodkorlik</span>
                                <span class="fw-bold text-success">{{ skill_map.creativity }}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between px-0">
                                <span>Muloqot</span>
                                <span class="fw-bold text-info">{{ skill_map.communication }}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between px-0">
                                <span>Jamoaviy ishlash</span>
                                <span class="fw-bold text-warning">{{ skill_map.teamwork }}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between px-0">
                                <span>Moslashuvchanlik</span>
                                <span class="fw-bold text-secondary">{{ skill_map.adaptive_learning }}%</span>
                            </li>
                        </ul>
                        <div class="mt-3 text-muted" style="font-size: 0.8rem;">
                            <i class="bi bi-info-circle me-1"></i> So'nggi yangilanish: {{
                            skill_map.updated_at|date:"d.m.Y" }}
                            <br>
                            (O'qituvchi: {{ skill_map.updated_by.get_full_name }})
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('skillRadarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: [
                    'Tanqidiy Fikrlash',
                    'Ijodkorlik',
                    'Muloqot',
                    'Jamoaviy Ishlash',
                    'Moslashuvchanlik'
                ],
                datasets: [{
                    label: 'O\'quvchi Ko\'rsatkichlari',
                    data: [
                        {{ skill_map.critical_thinking }},
                {{ skill_map.creativity }},
                        {{ skill_map.communication }},
        {{ skill_map.teamwork }},
        {{ skill_map.adaptive_learning }}
                    ],
        fill: true,
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgb(54, 162, 235)',
        pointBackgroundColor: 'rgb(54, 162, 235)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            },
        options: {
        elements: {
            line: {
                borderWidth: 3
            }
        },
        scales: {
            r: {
                angleLines: {
                    display: true
                },
                suggestedMin: 0,
                suggestedMax: 100
            }
        }
    }
        });
    });
</script>
{% endif %}

<script>
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = event.target.closest('.position-relative').querySelector('img');
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }
</script>
{% endblock %}